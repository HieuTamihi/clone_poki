<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>PokiWar - Match-3 RPG Adventure</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Game Match-3 RPG thu ph·ª•c pet th√∫ v·ªã">
    <meta name="theme-color" content="#1e88e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PokiWar">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    
    <!-- Styles -->
    <link rel="stylesheet" href="styles-3d.css">
    
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4878455337844727"
     crossorigin="anonymous"></script>
</head>
<body>
    <div id="app">
        <!-- TOP BAR -->
        <div class="top-bar">
            <div class="player-avatar-top">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%234dabf7'/%3E%3Ctext x='50' y='65' font-size='50' text-anchor='middle' fill='white'%3Eüë§%3C/text%3E%3C/svg%3E" alt="Avatar">
            </div>
            <div class="top-nav-menu" style="display: flex; gap: 1rem; align-items: center; flex: 1; justify-content: center;">
                <a href="about.html" style="color: white; text-decoration: none; font-weight: 500; font-size: 0.9rem; padding: 0.5rem 1rem; background: rgba(255,255,255,0.1); border-radius: 20px; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">üìñ Gi·ªõi Thi·ªáu</a>
                <a href="guide.html" style="color: white; text-decoration: none; font-weight: 500; font-size: 0.9rem; padding: 0.5rem 1rem; background: rgba(255,255,255,0.1); border-radius: 20px; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">üìö H∆∞·ªõng D·∫´n</a>
                <a href="blog.html" style="color: white; text-decoration: none; font-weight: 500; font-size: 0.9rem; padding: 0.5rem 1rem; background: rgba(255,255,255,0.1); border-radius: 20px; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">üìù Blog</a>
                <a href="privacy.html" style="color: white; text-decoration: none; font-weight: 500; font-size: 0.9rem; padding: 0.5rem 1rem; background: rgba(255,255,255,0.1); border-radius: 20px; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">üîí Ch√≠nh S√°ch</a>
            </div>
            <div class="resources">
                <div class="resource-item gold">
                    <button class="add-btn">+</button>
                    <span class="resource-value" id="top-gold">579M</span>
                    <span class="resource-icon">üí∞</span>
                </div>
                <div class="resource-item gems">
                    <button class="add-btn">+</button>
                    <span class="resource-value" id="top-gems">60000</span>
                    <span class="resource-icon">üíé</span>
                </div>
            </div>
        </div>

        <!-- LOBBY SCREEN (3D Isometric) -->
        <div id="screen-lobby-3d" class="screen active">
            <div class="lobby-3d-container">
                <!-- Main Central Building -->
                <div class="island-item main-building" style="left: 50%; top: 40%; transform: translate(-50%, -50%);">
                    <div class="island-platform large">
                        <div class="building-3d central-tower">
                            <div class="tower-top"></div>
                            <div class="tower-body"></div>
                            <div class="tower-base"></div>
                        </div>
                    </div>
                    <div class="island-label">Ph√≥ B·∫£n</div>
                </div>

                <!-- Top Left - Dot Pha (Breakthrough) -->
                <div class="island-item" style="left: 15%; top: 20%;" onclick="showNotification('üå∏ ƒê·ªôt Ph√° - Coming Soon!')">
                    <div class="island-platform small">
                        <div class="building-3d mushroom-house">
                            <div class="mushroom-cap"></div>
                            <div class="mushroom-stem"></div>
                        </div>
                    </div>
                    <div class="island-label">ƒê·ªôt Ph√°</div>
                </div>

                <!-- Top Right - Arena -->
                <div class="island-item" style="left: 75%; top: 15%;" onclick="showNotification('‚öîÔ∏è ƒê·∫•u Tr∆∞·ªùng - Coming Soon!')">
                    <div class="island-platform medium">
                        <div class="building-3d arena">
                            <div class="arena-top"></div>
                            <div class="arena-body"></div>
                        </div>
                    </div>
                    <div class="island-label">ƒê·∫•u Tr∆∞·ªùng</div>
                </div>

                <!-- Left - Tree/Garden -->
                <div class="island-item" style="left: 8%; top: 50%;" onclick="showScreen('collection')">
                    <div class="island-platform small">
                        <div class="building-3d tree">
                            <div class="tree-crown"></div>
                            <div class="tree-trunk"></div>
                        </div>
                    </div>
                    <div class="island-label">C√¢y Ti·∫øn Tr√≠</div>
                </div>

                <!-- Left Center - Forge -->
                <div class="island-item" style="left: 25%; top: 55%;" onclick="showNotification('üî® Nh√† R√®n - Coming Soon!')">
                    <div class="island-platform medium">
                        <div class="building-3d forge">
                            <div class="forge-roof"></div>
                            <div class="forge-body"></div>
                        </div>
                    </div>
                    <div class="island-label">Nh√† R√®n</div>
                </div>

                <!-- Right - Event -->
                <div class="island-item" style="left: 72%; top: 58%;" onclick="showNotification('üéâ Event - Coming Soon!')">
                    <div class="island-platform medium">
                        <div class="building-3d event-building">
                            <div class="event-top"></div>
                            <div class="event-body"></div>
                        </div>
                    </div>
                    <div class="island-label">Event</div>
                </div>
            </div>
        </div>

        <!-- BOTTOM MENU -->
        <div class="bottom-menu">
            <div class="menu-item active" onclick="showScreen('lobby-3d')">
                <div class="menu-icon">üè†</div>
                <div class="menu-label">S·∫£nh</div>
            </div>
            <div class="menu-item" onclick="showScreen('planets')">
                <div class="menu-icon">üåç</div>
                <div class="menu-label">Ph√≥ B·∫£n</div>
            </div>
            <div class="menu-item" onclick="showScreen('collection')">
                <div class="menu-icon">üëæ</div>
                <div class="menu-label">Kho Pet</div>
            </div>
            <div class="menu-item" onclick="showNotification('üè™ Shop - Coming Soon!')">
                <div class="menu-icon">üè™</div>
                <div class="menu-label">C·ª≠a H√†ng</div>
            </div>
        </div>

        <!-- PLANETS SCREEN -->
        <div id="screen-planets" class="screen">
            <div class="screen-header-3d">
                <button class="back-btn-3d" onclick="showScreen('lobby-3d')">‚Üê Quay l·∫°i</button>
                <h2>üåç Ch·ªçn H√†nh Tinh</h2>
            </div>
            <div class="planets-grid-3d" id="planets-list"></div>
        </div>

        <!-- STAGES SCREEN -->
        <div id="screen-stages" class="screen">
            <div class="screen-header-3d">
                <button class="back-btn-3d" onclick="showScreen('planets')">‚Üê Quay l·∫°i</button>
                <h2 id="planet-title">üåç H√†nh Tinh</h2>
            </div>
            <div class="stages-grid-3d" id="stages-list"></div>
        </div>

        <!-- COLLECTION SCREEN -->
        <div id="screen-collection" class="screen">
            <div class="screen-header-3d">
                <button class="back-btn-3d" onclick="showScreen('lobby-3d')">‚Üê Quay l·∫°i</button>
                <h2>üëæ Kho Pet</h2>
            </div>
            <div class="collection-filters">
                <button class="filter-btn active" data-filter="all">T·∫•t c·∫£</button>
                <button class="filter-btn" data-filter="fire">üî• L·ª≠a</button>
                <button class="filter-btn" data-filter="water">üíß N∆∞·ªõc</button>
                <button class="filter-btn" data-filter="earth">üåç ƒê·∫•t</button>
                <button class="filter-btn" data-filter="air">üí® Gi√≥</button>
            </div>
            <div class="pets-grid-3d" id="collection-list"></div>
        </div>

        <!-- STATS SCREEN -->
        <div id="screen-stats" class="screen">
            <div class="screen-header-3d">
                <button class="back-btn-3d" onclick="showScreen('lobby-3d')">‚Üê Quay l·∫°i</button>
                <h2>üìä Th·ªëng K√™</h2>
            </div>
            <div class="stats-container" id="stats-content"></div>
        </div>

        <!-- PREPARE BATTLE SCREEN -->
        <div id="screen-prepare" class="screen">
            <div class="screen-header-3d">
                <button class="back-btn-3d" onclick="showScreen('stages')">‚Üê Quay l·∫°i</button>
                <h2 id="prepare-title">‚öîÔ∏è Chu·∫©n B·ªã Tr·∫≠n ƒê·∫•u</h2>
            </div>
            
            <div class="prepare-container-3d">
                <div class="enemy-preview-3d">
                    <h3>ƒê·ªëi Th·ªß</h3>
                    <div class="enemy-card-3d">
                        <div class="enemy-portrait-large" id="prepare-enemy-portrait">üêæ</div>
                        <div class="enemy-info">
                            <div class="enemy-name" id="prepare-enemy-name">???</div>
                            <div class="enemy-stats">
                                <div class="stat-item">
                                    <span class="stat-icon">‚ù§Ô∏è</span>
                                    <span id="prepare-enemy-hp">100</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-icon">‚öîÔ∏è</span>
                                    <span id="prepare-enemy-atk">10</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="rewards-info-3d">
                        <h4>Ph·∫ßn Th∆∞·ªüng</h4>
                        <div class="reward-item">üí∞ <span id="prepare-reward-gold">50</span> Gold</div>
                        <div class="reward-item">‚≠ê <span id="prepare-reward-exp">40</span> EXP</div>
                    </div>
                </div>

                <div class="team-selection-3d">
                    <h3>ƒê·ªôi H√¨nh C·ªßa B·∫°n</h3>
                    <div class="selected-pets-3d" id="selected-pets-list">
                        <div class="pet-slot-3d empty" onclick="selectPetForBattle(0)">
                            <div class="slot-number">1</div>
                            <div class="slot-hint">Click ƒë·ªÉ ch·ªçn</div>
                        </div>
                        <div class="pet-slot-3d empty" onclick="selectPetForBattle(1)">
                            <div class="slot-number">2</div>
                            <div class="slot-hint">Click ƒë·ªÉ ch·ªçn</div>
                        </div>
                        <div class="pet-slot-3d empty" onclick="selectPetForBattle(2)">
                            <div class="slot-number">3</div>
                            <div class="slot-hint">Click ƒë·ªÉ ch·ªçn</div>
                        </div>
                    </div>

                    <div class="available-pets">
                        <h4>Pet C√≥ S·∫µn</h4>
                        <div class="pets-list-small" id="available-pets-list"></div>
                    </div>

                    <button class="start-battle-btn-3d" onclick="startBattle()">
                        ‚öîÔ∏è B·∫Øt ƒê·∫ßu Tr·∫≠n Chi·∫øn
                    </button>
                </div>
            </div>
        </div>

        <!-- BATTLE SCREEN -->
        <div id="screen-battle" class="screen">
            <div class="battle-header-3d">
                <button class="back-btn-3d" onclick="retreatBattle()">üèÉ R√∫t Lui</button>
                <div class="battle-info">
                    <span id="battle-stage-name">·∫¢i 1</span>
                </div>
            </div>

            <div class="battle-container-3d">
                <!-- Player Side (Left) -->
                <div class="battle-player-3d">
                    <div class="player-pets" id="battle-player-pets"></div>
                    <div class="player-hp-bar">
                        <div class="hp-label">HP</div>
                        <div class="hp-meter">
                            <span id="battle-player-hp-text">100/100</span>
                            <div class="hp-fill" id="battle-player-hp-fill"></div>
                        </div>
                    </div>
                    <div class="player-mp-bar">
                        <div class="mp-label">MP</div>
                        <div class="mp-meter">
                            <span id="battle-player-mp-text">50/50</span>
                            <div class="mp-fill" id="battle-player-mp-fill"></div>
                        </div>
                    </div>
                </div>

                <!-- Match-3 Board (Center) -->
                <div class="board-section-3d">
                    <div class="turn-indicator-3d" id="battle-turn">L∆∞·ª£t c·ªßa b·∫°n</div>
                    <div id="battle-board" class="board-3d"></div>
                    <div class="battle-skills-3d">
                        <button class="skill-btn-3d" id="skill-btn-1" onclick="usePetSkill(0)">
                            <span class="skill-icon">üî•</span>
                            <span class="skill-name">Skill 1</span>
                            <span class="skill-cost">30 MP</span>
                        </button>
                        <button class="skill-btn-3d" id="skill-btn-2" onclick="usePetSkill(1)">
                            <span class="skill-icon">ÔøΩ</span>
                            <span class="skill-name">Skill 2</span>
                            <span class="skill-cost">30 MP</span>
                        </button>
                        <button class="skill-btn-3d" id="skill-btn-3" onclick="usePetSkill(2)">
                            <span class="skill-icon">‚ö°</span>
                            <span class="skill-name">Skill 3</span>
                            <span class="skill-cost">30 MP</span>
                        </button>
                    </div>
                </div>

                <!-- Enemy Side (Right) -->
                <div class="battle-enemy-3d">
                    <div class="enemy-portrait-battle" id="battle-enemy-portrait">üêæ</div>
                    <div class="enemy-name-battle" id="battle-enemy-name">Enemy</div>
                    <div class="enemy-hp-bar">
                        <div class="hp-label">HP</div>
                        <div class="hp-meter enemy">
                            <span id="battle-enemy-hp-text">80/80</span>
                            <div class="hp-fill enemy" id="battle-enemy-hp-fill"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- OVERLAY / MODAL -->
        <div id="overlay" class="overlay hidden">
            <div class="dialog-3d">
                <h2 id="overlay-title"></h2>
                <p id="overlay-desc"></p>
                <div id="overlay-content"></div>
                <button id="overlay-close" class="dialog-btn-3d">OK</button>
            </div>
        </div>

        <!-- PET SELECTION MODAL -->
        <div id="pet-select-modal" class="overlay hidden">
            <div class="dialog-3d pet-select-dialog">
                <h2>Ch·ªçn Pet</h2>
                <div class="pet-select-grid" id="pet-select-grid"></div>
                <button onclick="closePetSelectModal()" class="dialog-btn-3d">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <script src="game-data.js"></script>
    <script src="game-state.js"></script>
    <script src="game-ui.js"></script>
    <script src="game-battle.js"></script>
    <script src="main.js"></script>
    
    <!-- PWA Service Worker Registration -->
    <script>
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then((registration) => {
                        console.log('‚úÖ Service Worker registered:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('‚ùå Service Worker registration failed:', error);
                    });
            });
        }
        
        // Install Prompt
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button
            showInstallButton();
        });
        
        function showInstallButton() {
            // Create install button if not exists
            if (!document.getElementById('install-btn')) {
                const btn = document.createElement('button');
                btn.id = 'install-btn';
                btn.innerHTML = 'üì≤ C√†i ƒë·∫∑t App';
                btn.style.cssText = `
                    position: fixed;
                    bottom: 80px;
                    right: 20px;
                    background: linear-gradient(135deg, #1e88e5, #1565c0);
                    color: white;
                    border: none;
                    padding: 12px 20px;
                    border-radius: 25px;
                    font-size: 14px;
                    font-weight: 600;
                    cursor: pointer;
                    z-index: 9999;
                    box-shadow: 0 4px 15px rgba(30, 136, 229, 0.4);
                    animation: pulse 2s ease-in-out infinite;
                `;
                btn.onclick = installApp;
                document.body.appendChild(btn);
            }
        }
        
        async function installApp() {
            if (!deferredPrompt) return;
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                console.log('‚úÖ ƒê√£ c√†i ƒë·∫∑t PWA');
            }
            
            deferredPrompt = null;
            document.getElementById('install-btn')?.remove();
        }
        
        // Detect if app is installed
        window.addEventListener('appinstalled', () => {
            console.log('‚úÖ PWA ƒë√£ ƒë∆∞·ª£c c√†i ƒë·∫∑t');
            document.getElementById('install-btn')?.remove();
        });
        
        // ==========================================
        // FORCE LANDSCAPE MODE ON MOBILE
        // ==========================================
        
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        function checkOrientation() {
            const app = document.getElementById('app');
            if (!app) return;
            
            // Only apply on mobile devices
            if (!isMobile) {
                app.style.transform = '';
                app.style.transformOrigin = '';
                app.style.width = '';
                app.style.height = '';
                app.style.position = '';
                return;
            }
            
            const isPortrait = window.innerHeight > window.innerWidth;
            
            if (isPortrait) {
                // Force landscape by rotating the app
                const vh = window.innerHeight;
                const vw = window.innerWidth;
                
                app.style.position = 'fixed';
                app.style.top = '0';
                app.style.left = '0';
                app.style.width = vh + 'px';
                app.style.height = vw + 'px';
                app.style.transform = 'rotate(90deg)';
                app.style.transformOrigin = 'top left';
                app.style.marginLeft = vw + 'px';
                
                // Hide scrollbars
                document.body.style.overflow = 'hidden';
                
                console.log('üì± Portrait detected - Rotating to landscape');
            } else {
                // Normal landscape mode
                app.style.transform = '';
                app.style.transformOrigin = '';
                app.style.width = '100%';
                app.style.height = '100vh';
                app.style.position = 'relative';
                app.style.marginLeft = '';
                app.style.top = '';
                app.style.left = '';
                
                document.body.style.overflow = 'hidden';
                
                console.log('üì± Landscape mode');
            }
        }
        
        // Check on load and resize
        window.addEventListener('load', checkOrientation);
        window.addEventListener('resize', checkOrientation);
        window.addEventListener('orientationchange', () => {
            setTimeout(checkOrientation, 100);
        });
        
        // Lock screen orientation if available
        if (screen.orientation && screen.orientation.lock) {
            screen.orientation.lock('landscape').catch(() => {
                console.log('Screen orientation lock not supported');
            });
        }
    </script>
</body>
</html>

